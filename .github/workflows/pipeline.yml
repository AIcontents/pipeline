name: CI quality + release + telegram

on:
  pull_request:
    branches: ["dev"]
    types: ["closed"]

jobs:
  quality:
    if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'feature/ticket-')
    runs-on: ubuntu-latest

    outputs:
      report_path: reports/flake8_report.txt

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run flake8 and save report
        id: flake8
        run: |
          mkdir -p reports
          set +e
          flake8 . > reports/flake8_report.txt
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake8-report
          path: reports/flake8_report.txt

      - name: Fail if flake8 found issues
        if: steps.flake8.outputs.exit_code != '0'
        run: exit 1


  release:
    needs: quality
    if: needs.quality.result == 'success'
    runs-on: ubuntu-latest

    outputs:
      release_url: ${{ steps.create_release.outputs.html_url }}
      release_tag: ${{ steps.create_release.outputs.tag_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate release tag
        id: tag
        run: |
          TAG="release-$(date +'%Y%m%d-%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Release ${{ steps.tag.outputs.tag }}"
          body: |
            Merge PR #${{ github.event.pull_request.number }}
            Branch: ${{ github.head_ref }}
            Merged at: ${{ github.event.pull_request.merged_at }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload flake8 report to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: reports/flake8_report.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  telegram_notify:
    needs: [quality, release]
    if: always() && github.event.pull_request.merged == true && startsWith(github.head_ref, 'feature/ticket-')
    runs-on: ubuntu-latest

    steps:
      - name: Send Telegram message
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RESULT: ${{ needs.quality.result }}
          RELEASE_URL: ${{ needs.release.outputs.release_url }}
          RELEASE_TAG: ${{ needs.release.outputs.release_tag }}
        run: |
          STATUS_EMOJI="‚úÖ"
          if [ "$RESULT" != "success" ]; then
            STATUS_EMOJI="‚ùå"
          fi

          TEXT=$(printf "%s *Pipeline Result:* %s\n\nüì¶ *Repository:* %s\nüîÄ *Merged Branch:* %s ‚Üí %s\nüìÖ *Merged At:* %s\n\nüîó *PR:* %s\nüöÄ *Release:* %s\nüìé *Run:* %s/%s/actions/runs/%s" \
            "$STATUS_EMOJI" \
            "$RESULT" \
            "${{ github.repository }}" \
            "${{ github.head_ref }}" \
            "${{ github.base_ref }}" \
            "${{ github.event.pull_request.merged_at }}" \
            "${{ github.event.pull_request.html_url }}" \
            "$RELEASE_URL" \
            "${{ github.server_url }}" \
            "${{ github.repository }}" \
            "${{ github.run_id }}")

          RESP=$(curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "parse_mode=Markdown" \
            --data-urlencode "text=${TEXT}")

          echo "$RESP"
          echo "$RESP" | grep -q '"ok":true' || exit 1
